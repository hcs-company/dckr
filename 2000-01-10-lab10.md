## Lab 10: Operations with images

#### Objectives

You are already familiar with one command, `docker images`. You can also remove images, tag and untag them.

--------

#### Step 1: Build a new version

First let build the new figlet v3 from Dockerfile, so that we have more versions.
```
 $ docker build -t figlet:v3 .
```

--------

#### Step 2: Removing images and containers

Let's start with removing the image figlet version 1 (figlet:v1) that takes too much disk space:

```
$ docker rmi figlet:v1
Error response from daemon: conflict: unable to remove repository reference "figlet:v1" (must force) - container 3b8931ffdacd is using its referenced image bbc0e5eb5777

```

Docker complains that there are containers using this image. How is this possible? We thought that all our containers are gone.
Actually, Docker keeps track of all containers, even those that have stopped:

```
$ docker ps -a
CONTAINER ID        IMAGE               COMMAND                    CREATED             STATUS                        PORTS                    NAMES
74ed5559950b        figlet              "bash"                     5 hours ago         Exited (127) 5 seconds ago                             stupefied_colden
025bc7941f8d        figlet              "bash"                     5 hours ago         Exited (0) 17 minutes ago                              determined_mestorf
2a4897f417e6        figlet              "/bin/sh -c 'figle..."     5 hours ago         Exited (0) 18 minutes ago                              infallible_euler
```

We can now delete the container:

```
$ docker rm 74ed5559950b
74ed5559950b
```

and the image:

```
$ docker rmi figlet:v1
Untagged: figlet:v1
Deleted: sha256:1deb0689407271616d779920b479c2f1fcacb704f7d2b1a155f30e53cb63754f
Deleted: sha256:78564bb1cdb863ad490ba272d04b5c1bf60bb390bd3a9d9aa6ce5e140d597bc3
Deleted: sha256:ed08aaa4b5b884fd1270c3171709063a941bb0cf2f9e8201fc5166be3e406b1e
```

--------

#### Step 3: Tagging images

`docker tag` helps us to tag images.

We have a lot of versions of `figlet` built, but latest still points to the old `v1`.

```
$ docker images | grep figlet
figlet                                             v2                  bbc0e5eb5777        2 days ago          170 MB
figlet                                             v3                  bbc0e5eb5777        2 days ago          170 MB
figlet                                             latest              b7fa8e20196b        2 days ago          170 MB
figlet                                             v1                  b7fa8e20196b        2 days ago          170 MB
```

Let's change that by re-tagging `latest` to `v4`:

```
$ docker tag figlet:v4 figlet:latest
$ docker images | grep figlet

```

Both `v4` and `latest` point to the same image ID.

--------

#### Step 4: Publishing images to a local registry

Docker expects all registries to run on HTTPS. But for this lab we will run a version on HTTP. The Docker Engine needs to be explicitly setup to use HTTP for the insecure registry. 

In Docker for Mac, the Preferences menu lets you set the address for an insecure registry under the Daemon panel: 

![docker-settings-mac](img/docker_osx_insecure_registry.png)

In Docker for Windows, the Settings menu lets you set the address for an insecure registry under the Daemon panel: 

![docker-settings-windows](img/docker_windows_insecure_registry.png)

Images are distributed with a special service - `docker registry`.
Let us spin up a local registry:

```
$ docker run -p 5000:5000 --name registry -d registry:2
```

`docker push` is used to publish images to registries.

To instruct where we want to publish, we need to append registry address to repository name:

```
$ docker tag figlet:v4 127.0.0.1:5000/figlet:v4
$ docker push 127.0.0.1:5000/figlet:v4
```

`docker push` pushed the image to our "remote" registry.

--------

#### Step 5: Stop all dockers containers and images

Enter the following commands to clean up:

```
# Stop all docker containers
$ docker stop $(ps docker -q -a | grep figlet)

# Delete every Docker containers
# Must be run first because images are attached to containers
$ docker rm -f $(docker ps -a -q | grep figlet)

# Delete every Docker image
$ docker rmi -f $(docker images -q | grep figlet)
```
See that the figlet images are removed.

```
$ docker images -q | grep figlet
```

--------

#### Step 6: PULL the image from registry

We can now download the image using the `docker pull` command:

```
$ docker pull 127.0.0.1:5000/figlet
v4: Pulling from figlet
Digest: sha256:c472a7ec8ab2b0db8d0839043b24dbda75ca6fa8816cfb6a58e7aaf3714a1423
Status: Image is up to date for 127.0.0.1:5000/figlet
```

and see that it is pulled.

```
$ docker images
```

Repeat **Step 5** if you want a clean envoirement. 

